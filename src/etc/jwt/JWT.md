# JWT(Json Web Token)


**Json 포맷을 이용하여 사용자에 대한 속성를 저장하는 Claim 기반의 Web Token**이다.

JWT는 토큰 자체를 정보로 사용하는 Self-Contained(자가 수용적) 방식으로 정보를 안전하게 전달한다.

JWT를 사용하면 restful과 같은 무상태인 환경에서 사용자 데이터를 주고받을 수 있게 된다.

Session을 사용하게 될 경우에는 쿠키 등을 통해 사용자를 식별하고 서버에 세션을 저장했지만

JWT와 같은 토큰을 클라이언트에 저장하고 요청시 HTTP 헤더에 토큰을 첨부하는 것만으로도 단순하게 데이터를 요청하고 응답을 받아올 수 있다.


## 구조

JWT는 Header, Payload, Signature로 구성된다.

### Header

**토큰의 타입(typ)과 해시 알고리즘(alg)** 의 종류가 담겨있다.

alg는 헤더를 암호화 하는 것이 아니고, **Signature를 해싱하기 위한 알고리즘을 지정**하는 것이다.

```json
{
  "typ" : "JWT",
  "alg" : "HS512"
}
```

### Payload

토큰의 페이로드에는 **사용할 정보의 조각들인 클레임**이 담겨있다.

클레임은 총 3가지로 나누어지며, Key/Value 형태로 다수의 정보를 넣을 수 있다.

> 등록된 클레임(Registered Claims)
> 
> 등록된 클레임은 토큰 정보를 표현하기 위해 이미 정해진 종류의 데이터들이다.
> 
> 선택적으로 작성이 가능하며, 사용할 것을 권장한다.
> 
> JWT를 간결하게 하기 위해 key의 길이는 모두 3이다. 여기서 subject로는 unique한 값을 사용하는데, 사용자 이메일을 주로 사용한다.
> 
> iss : 토큰 발급자(issuer)
> 
> sub : 토큰 제목(subject)
> 
> aud : 토큰 대상자(audience)
> 
> exp : 토큰 만료 시간(expiration)
> 
> nbf : 토큰 활성 날짜(not before), 이 날이 지나기 전의 토큰은 활성화되지 않는다.
> 
> iat : 토큰 발급 시간(issued at)
> 
> jti : JWT 토큰 식별자(JWT ID), 중복 방지를 위해 사용, 일회용 토큰(Access Token)등에 사용
> 
> ```json 
> {
>   "sub": "subject",
>   "iss": "abc"
> }
> ```

> 공개 클레임(Public Claims)
> 
> 공개 클레임들은 충돌이 방지된 이름을 가지고 있어야한다. 주로 URI 형식으로 짓는다.
> 
> ```json
> {
>   "https://test.io/jwt/public" : true
> }
> ```

> 비공개 클레임(Private Cliams)
> 
> 클라이언트와 서버 협의하에 사용되는 클레임이다. 이름이 중복되어 충돌될 수 있기 때문에 유의해야 한다.
> 
> ```json
> {
>   "token_type" : "access"
> }
> ```


### Signature

Header, Payload를 Base64 URL-safe Encode 한 이후, Header에 명시된 해시함수를 적용하고

이 값을 다시 Base64 URL로 인코딩하여 생성한다.

개인키(Private Key)로 서명한 **전자서명**이 담겨있다.

이는 Header, Payload가 변조되었는지 확인하기 위해 사용되는 중요 정보이며, JWT를 신뢰할 수 있는 토큰으로 사용할 수 있는 근거가 된다.


## 단점 및 고려사항

Self-contained : 토큰 자체에 정보를 담고 있으므로 양날의 검이 될 수 있다.

토큰 길이 : paylod에 3종류의 클레임을을 저장하기 때문에, 정보가 많아질수록 토큰의 길이가 늘어나 네트워크에 부하를 줄 수 있다.

payload 인코딩 : 페이로드 자체는 암호화 된 것이 아니라 Base64 Url로 인코딩 된 것이다. 중간에 payload를 탈취하여 디코딩하면 데이터를 다 볼 수 있으므로, JWE로 암호화 하거나 **Payload에 중요 데이터를 넣지 않아야 한다.** 

Stateless : JWT는 상태를 저장하지 않기 때문에 한번 만들어지면 제어가 불가능하다. 즉, 토큰을 임의로 삭제하는 것이 불가능하므로 토큰 말료 시간을 꼭 넣어줘야 한다.

Store Token : 토큰은 클라이언트 측에서 관리해야 하기 때문에 토큰을 저장해야 한다.



## JWT와 세션의 차이점

JWT와 세션의 가장 큰 차이점은 **인가**에 대한 정보를 누가 담고 있냐이다.

세션은 서버의 세션 저장소에 해당 인증 내용을 담지만, JWT 토큰은 토큰 안에 인증 내용을 담고 있다.

사용자가 요청을 했을 떄 **토큰만 확인하면 되므로** 세션 관리가 필요 없어진다.

따라서 JWT 토큰을 활용하면 각각 로드 밸런싱된 서버에 토큰 검증 클래스나 메소드만 있으면 인가 과정을 해결할 수 있다.